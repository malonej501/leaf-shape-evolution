# leaf-shape-evolution

This repository contains code accompanying the paper Malone et al. (2025) "Developmental bias explains the evolutionary trend towards simple leaves".

## Installation

For a complete installation you will require:
- This repository
- VLAB 5.0
    - Available at https://algorithmicbotany.org/virtual_laboratory
    - Put in place of the directory `/vlab`
- Leaf developmental model from Runions et al. (2017)
    - Available at https://algorithmicbotany.org/papers/Leaves2017, file name should begin with `NPHLeafModels`
    - Extract into a directory called `/NPHLeafModels` and place inside `/vlab/oofs/ext`
- BayesTraits 4.1.2
    - Available at https://www.evolution.reading.ac.uk/BayesTraitsV4.0.0/BayesTraitsV4.0.0.html
    - Place inside `/BayesTraitsV4.1.2-Linux`

You may need to adjust paths in some of the scripts. The script `leaffinder.py` which runs the evolutionary simulations is designed to initiate multiple instances of the leaf model in parallel. To achieve this, copy the contents of `/NPHLeafModels` 10 times into directories called `/bin0`, `/bin1`, ..., `/bin9` inside the original `/NPHLeafModels` directory. The `/LeafGenerator` directory should remain inside `/NPHLeafModels`.

Further python package requirements are listed in `requirements.txt`. Futher R package requirements can be seen at the top of the Rscipts `/phylogeny/tree_handler.R` and `/phylogeny/tree_stats.R`.

## File guide

Some minor files (e.g. icons) are omitted from this guide for the sake of simplicity.

`/vlab/oofs/ext/NPHLeafModels/LeafGenerator` contains:
- `leaffinder.py` - the main script for running evolutionary simulations.
- `pdict.py` - for storing the parameter values for the leaves used to initiate the evolutionary simulations.
- `pwriter.py` - for writing parameter files for the Runions et al. leaf model for each step of the evolutoinary simulations.
- `Start.sh` - for starting an iteration of the Runions et al. leaf model.
- `walk_merge.py` - for merging simulation data generated over multiple executions.
- `morphospace_generator.py` - for generating the morphospace plot shown in figure 2c.

`/dataprocessing` contains:
- `classifier.py` - for classifying the shape of leaf images generated by the evolutionary simulations
- `classifier_ML.py` - a machine learning method for classifying the shape of leaf images generated by the evolutionary simulations. Not used in the results for the final paper.
- `curves.py` - for generating figures 3 and 8.
- `pca.py` - for generating figures 4a and 4b.
- `markov_fitter.py` - for fitting a continuous time Markov chain model to the output of the evolutionary simulations.
- `MUT2_320_mle_23-04-25.csv` - shape trajectories from the MUT2 simulation shown in the paper.
- `MUT5_320_mcmc_23-07-25_1.csv` - shape trajectories from the MUT5 simulation shown in the paper.
- `/markov_fitter_reports` - which contains the maximum likelihood and Markov chain Monte Carlo transition rates inferred from simulation data using `markov_fitter.py` that were used in the paper.

`/phylogeny` contains:
- `tree_handler.R` - for generating an intersect between phylogenetic trees and the herbarium data.
- `tree_stats.R` - for plotting and generating summary statistics for phylogenetic trees.
- `arrow_violin.py` - for generating figure 7a.
- `violin.py` - for generating figure 7b.
- `/phylo_data/trees_final` - which contains the trees used in the paper.
- `/shape_data` which contains:
    - `/labels_final` which contains the tip labels for the trees used in the paper.
    -  `/Naturalis` which contains:
        - `sample_angio.py` - for subsampling angiosperm families from the naturalis herbarium to achieve a more even sample over phylogeny.
        - `naturalis_classifier_eye.py` - a basic gui for displaying, iterating through and classifying downloaded herbarium images.
        - `rawshape_processing.py` - for checking all expected herbarium images are present and correctly labelled.
- `/rates` which contains:
    - `/ML` which contains all maximum likelihood rates inferred from the phylogenetic trees used in the paper.
    - `/uniform_1010000steps` which contains all the Markov chain Monte Carlo rate posteriors inferred from the phylogenetic trees used in the paper.

`/BayesTraits` contains:
- `inference.py` - for fitting a continuous time Markov chain model to phylogenetic trees using BayesTraits.
- `/data` - which contains the trees and labels used in the paper as well as the raw output of the BayesTraits fits used in the paper.
